name: Flutter Dependency Cacher Workflow

permissions:
  actions: write

on: workflow_call

jobs:
  ## flutter github-actions ì—ì„œ cache ì§€ì›í•˜ì—¬ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ì–´ì§
  # check-cache:
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     matrix:
  #       version: [3.13.6]
  #       channel: [stable]
  #       include:
  #         - os: ubuntu-latest
  #           flutter_path: /opt/hostedtoolcache/flutter
  #         - os: macos-latest
  #           flutter_path: /Users/runner/hostedtoolcache/flutter
  #     fail-fast: false

  #   env:
  #     working-directory: ./
  #   steps:
  #     - name: ğŸ“š ì½”ë“œ Checkout
  #       uses: actions/checkout@v4

  #     - name: â˜‘ï¸ ìºì‹œ ìˆëŠ”ì§€ í™•ì¸í•˜ê¸°
  #       uses: actions/cache/restore@v3
  #       id: cache-flutter
  #       with:
  #         path: ${{ matrix.flutter_path }}
  #         key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
  #         restore-keys: ${{ runner.os }}-flutter-
  #         lookup-only: true

  #     - name: ğŸ˜ˆ ìºì‹œ ì—†ëŠ” ê²½ìš° ìºì‹œ ì €ì¥ ì„¤ì •
  #       if: steps.cache-flutter.outputs.cache-hit != 'true'
  #       uses: actions/cache@v3
  #       with:
  #         path: ${{ matrix.flutter_path }}
  #         key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
  #         restore-keys: ${{ runner.os }}-flutter-

  #     - name: ğŸ¦ Flutter í™˜ê²½ì„¤ì •
  #       if: steps.cache-flutter.outputs.cache-hit != 'true'
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ matrix.version }}
  #         channel: ${{ matrix.channel }}

  #     - name: â• ì˜ì¡´ì„± ì„¤ì¹˜
  #       if: steps.cache-flutter.outputs.cache-hit != 'true'
  #       run: flutter pub get
  #       working-directory: ${{ env.working-directory }}

  ## í˜„ì¬ branch ì—ì„œ pubspec.lock ê°’ê³¼ ë§ëŠ” cache ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ì‚­ì œ
  clear-cache:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - name: ğŸ“š ì½”ë“œ Checkout
        uses: actions/checkout@v4

      - name: ğŸŒ´ ë¸Œëœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
        id: extract_branch
        shell: bash
        run: echo "current-branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT

      - name: ğŸ—‘ï¸ ìºì‹œ ì •ë¦¬
        env:
          hash: ${{ hashFiles('**/pubspec.lock') }}
          current-branch: ${{ steps.extract_branch.outputs.current-branch }}
        uses: actions/github-script@v6
        with:
          script: |
            console.log("About to clear");
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${{ env.current-branch }}`
            })

            // ê° í”Œë«í¼ ê°€ìƒí™˜ê²½(macOS, Linux)ì— ì €ì¥ë  cache ì´ë¦„ ëª©ë¡
            const targetCaches = [`macOS-flutter-${{ env.hash }}`, `Linux-flutter-${{ env.hash }}`]
            for (const cache of caches.data.actions_caches) {
              console.log(cache)
              // í˜„ì¬ ë²„ì „ì— ë§ëŠ” cache ì´ë¦„ì´ ì•„ë‹Œ ê²½ìš° ì‚­ì œ
              if (!targetCaches.includes(cache.key)) {
                console.log(`target cache to delete: ${cache.key}`)
                github.rest.actions.deleteActionsCacheById({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  cache_id: cache.id,
                })
              }
            }
            console.log("Clear completed")
